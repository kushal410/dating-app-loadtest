name: Dating App Load Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  k6-load-test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js (for k6-reporter + summary script)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3Ô∏è‚É£ Setup k6
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      # 4Ô∏è‚É£ Run k6 load test and export summary JSON
      - name: Run k6 load test
        id: k6
        run: |
          mkdir -p results
          # Export a compact summary JSON instead of raw streaming JSON
          k6 run loadtest/loadtest.js \
            --summary-export=results/summary.json

          echo "Load test completed. Summary saved to results/summary.json"

      # 5Ô∏è‚É£ Install k6-html-reporter and generate HTML report
      - name: Generate HTML report
        run: |
          npm install -g @harness/k6-reporter
          # Uses the summary generated above
          k6-reporter results/summary.json results/report.html
          echo "HTML report generated: results/report.html"

      # 6Ô∏è‚É£ Add a beautiful summary to the GitHub Actions 'Summary' tab
      - name: Publish pretty summary to job summary
        run: |
          node - << 'EOF'
          const fs = require('fs');
          const path = 'results/summary.json';

          if (!fs.existsSync(path)) {
            console.error('Summary file not found:', path);
            process.exit(1);
          }

          const data = JSON.parse(fs.readFileSync(path, 'utf8'));
          const metrics = data.metrics || {};

          const checks = (metrics.checks && metrics.checks.values) || {};
          const httpReqDuration = (metrics.http_req_duration && metrics.http_req_duration.values) || {};
          const httpReqs = (metrics.http_reqs && metrics.http_reqs.values) || {};
          const vus = (metrics.vus && metrics.vus.values) || {};

          const fmtNum = (v, digits = 2) =>
            typeof v === 'number' ? v.toFixed(digits) : 'n/a';

          let md = '';

          md += '## üöÄ Dating App k6 Load Test\n\n';

          if (data.root_group && data.root_group.name) {
            md += `**Scenario:** \`${data.root_group.name}\`\n\n`;
          }

          md += '### üìä Key Metrics\n\n';
          md += '| Metric | Value |\n';
          md += '| --- | --- |\n';

          if (typeof checks.rate === 'number') {
            const totalChecks = (checks.passes || 0) + (checks.fails || 0);
            const passRate = (checks.rate * 100).toFixed(2);

            md += `| ‚úÖ Check pass rate | ${passRate}% |\n`;
            md += `| ‚úÖ Checks (passes / fails) | ${(checks.passes || 0)} / ${(checks.fails || 0)} |\n`;
            md += `| ‚úÖ Total checks | ${totalChecks} |\n`;
          }

          if (Object.keys(httpReqDuration).length > 0) {
            md += `| ‚è±Ô∏è http_req_duration avg | ${fmtNum(httpReqDuration.avg)} ms |\n`;
            if (httpReqDuration['p(90)'] !== undefined) {
              md += `| ‚è±Ô∏è http_req_duration p(90) | ${fmtNum(httpReqDuration['p(90)'])} ms |\n`;
            }
            if (httpReqDuration['p(95)'] !== undefined) {
              md += `| ‚è±Ô∏è http_req_duration p(95) | ${fmtNum(httpReqDuration['p(95)'])} ms |\n`;
            }
          }

          if (Object.keys(httpReqs).length > 0) {
            md += `| üåê Total HTTP requests | ${httpReqs.count || 0} |\n`;
            if (httpReqs.rate !== undefined) {
              md += `| üåê HTTP requests / sec | ${fmtNum(httpReqs.rate)} |\n`;
            }
          }

          if (vus && vus.value !== undefined) {
            md += `| üë• Virtual users (VUs) | ${vus.value} |\n`;
          }

          md += '\n### üìÅ Artifacts\n\n';
          md += '- `results/summary.json` ‚Äì raw k6 summary JSON\n';
          md += '- `results/report.html` ‚Äì full interactive HTML report\n';

          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, md);
          EOF

      # 7Ô∏è‚É£ Upload summary JSON as artifact
      - name: Upload JSON summary
        uses: actions/upload-artifact@v4
        with:
          name: k6-summary-json
          path: results/summary.json

      # 8Ô∏è‚É£ Upload HTML report as artifact
      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: k6-html-report
          path: results/report.html
